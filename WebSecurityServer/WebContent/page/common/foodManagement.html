<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>食品管理</title>
	<link rel="stylesheet" type="text/css" href="../../css/head.css">
	<link rel="stylesheet" href="../../css/jqwidgets/styles/jqx.base.css" type="text/css" />
	<link rel="stylesheet" href="../../css/jqwidgets/styles/jqx.energyblue.css" type="text/css" />
	<script type="text/javascript" src="../../js/jquery-1.10.2.js"></script>
	<script type="text/javascript" src="../../js/AppUtil.js"></script>
	<script type="text/javascript" src="../../js/Constants.js"></script>
	
    <script type="text/javascript" src="../../js/jqwidgets/jqxcore.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxdata.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxbuttons.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxdropdownlist.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxlistbox.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxscrollbar.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxnumberinput.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxmenu.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxcheckbox.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxcombobox.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxgrid.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxgrid.filter.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxgrid.sort.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxgrid.pager.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxgrid.selection.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxgrid.grouping.js"></script> 
    <script type="text/javascript" src="../../js/jqwidgets/jqxgrid.columnsresize.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxgrid.columnsreorder.js"></script> 
    <script type="text/javascript" src="../../js/jqwidgets/jqxnumberinput.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxwindow.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/jqxinput.js"></script>
    <script type="text/javascript" src="../../js/jqwidgets/gettheme.js"></script>
    
    <script type="text/javascript">
    
		var theme = 'energyblue';
		var data = [];
		var categories = [];
    	
	   	function groupByCategory(flag){
		   	if(flag){
		   		$("#jqxgrid").jqxGrid('addgroup', 'category');
		   	} else {
		   		$("#jqxgrid").jqxGrid('removegroup', 'category');
		   	}
	   	}
	   	
	   	function addCategory(category){
			for(var i = 0; i < categories.length; i++){
				if(categories[i] == category){
					return;
				}
			}
			categories.push(category);
	   	}
    
	   	function hasCategory(category){
			for(var i = 0; i < categories.length; i++){
				if(categories[i] == category){
					return true;
				}
			}
			return false;
	   	}
	   	
	   	function setupView(){
	   		
	   		var source = {
    			localdata : data,
    			datatype: "array",
                addrow: function (rowid, rowdata, position, commit) {
                    commit(true);
                },
                deleterow: function (rowid, commit) {
                    commit(true);
                },
                updaterow: function (rowid, newdata, commit) {
                	var status = newdata.available == true? Constants.FOOD_STATUS_OK : Constants.FOOD_STATUS_NO;
                	var param = {
                		"food.id" : newdata.id,
                		"food.name" : newdata.name,
                		"food.category" : newdata.category,
                		"food.description" : newdata.desc,
                		"food.price" : newdata.price,
                		"food.status" : status
                	};
                	AppUtil.request("updateFood.action", param, function(data){
                		if(data){
                			var result = data.isSuccess;
                			if(result == true){
                				commit(true);
                			} else {
                				alert(data.detail);
                			}
                		} else {
                			alert("操作失败");
                		}
                		commit(false);
                		
                	}, function(){
                		alert("操作失败");
                		commit(false);
                	});
                }
	    	}
	   		
	    	$("#popupWindow").jqxWindow({width: '250px', height: '260px', theme: theme, autoOpen: false, isModal: true});
	    	$("#category").jqxComboBox({source: categories, selectedIndex: 0, width: '120px', height: '25px', theme: theme});
	    	$("#price").jqxNumberInput({symbol: 'rmb', width: 120, height: 23, theme: theme, spinButtons: true });
    	 	$("#status").jqxCheckBox({ width: 120, theme: theme });
    	 	
    	 	var dataAdapter = new $.jqx.dataAdapter(source);
    	 	var editrow = -1;
	    	$("#jqxgrid").jqxGrid(
   			{		
   				theme : theme,
				autoheight: true,
    			width: 800,
    			showgroupmenuitems: false,
                sortable: true,
                pageable: true,
    		    source: dataAdapter,
    		    pagesizeoptions: ['10', '20', '30'],
    		    pagesize: 20,
    		    columns: [
    		        { text: '菜名', datafield: 'name', width: 250 },
    		        { text: '类别', datafield: 'category', width: 100 },
    		        { text: '描述', datafield: 'desc', width: 200 },
    		        { text: '价格', datafield: 'price', width: 100 },
    		        { text: '状态', datafield: 'status', width: 60},
    		        { text: '操作', datafield: 'Edit', columntype: 'button', 
    		        	cellsrenderer: function () {
                        	return "修改";
                     	}, 
                     	buttonclick: function (row) {
	                        // open the popup window when the user clicks a button.
	                        editrow = row;
	                        var offset = $("#jqxgrid").offset();
	                        var height = ($("#jqxgrid").jqxGrid('height')- 260)/2;
	                        $("#popupWindow").jqxWindow({ position: { x: parseInt(offset.left) + 275, y: parseInt(offset.top) + height } });
	                        // get the clicked row's data and initialize the input fields.
	                        var dataRecord = $("#jqxgrid").jqxGrid('getrowdata', editrow);
	                        $("#name").val(dataRecord.name);
	                        $("#category").val(dataRecord.category);
	                        $("#desc").val(dataRecord.desc);
	                        $("#price").jqxNumberInput({ decimal: dataRecord.price });
	                        $("#status").jqxCheckBox({ checked : dataRecord.available });
	                        $("#popupWindow").jqxWindow('open');
                    	}
                    }
    		    ],
    		    groupable: true,
    		    showgroupsheader : false,
    		});
    	 	var localizationobj = {};
    	 	localizationobj.pagergotopagestring = "跳转至";
    	 	localizationobj.pagershowrowsstring = " 显示";
    	 	localizationobj.pagerrangestring = " 共 ";
    	 	localizationobj.sortascendingstring = "从低到高排序";
            localizationobj.sortdescendingstring = "从高到低排序";
            localizationobj.sortremovestring = "取消排序";
	    	$("#jqxgrid").jqxGrid('localizestrings', localizationobj);
	    	
	    	$("#savebtn").jqxButton({theme: theme, width: '50', height: '25'});
            $("#cancelbtn").jqxButton({ theme: theme, width: '50', height: '25' });
	    	
            $("#savebtn").bind('click', function(event){
            	if(editrow >= 0){
                	var name = $("#name").val();
                	var category = $("#category").val();
                	var desc = $("#desc").val();
                	var price = $('#price').jqxNumberInput('decimal');
                	var status = -1;
                	var available = true;
                	if($("#status").jqxCheckBox('checked') == true){
                		status = AppUtil.getFoodStatus(Constants.FOOD_STATUS_OK);
                		available = true;
                	} else {
                		status = AppUtil.getFoodStatus(Constants.FOOD_STATUS_NO);
                		available = false;
                	}
                	var rowID = $('#jqxgrid').jqxGrid('getrowid', editrow);
                    var rowData = $('#jqxgrid').jqxGrid('getrowdata', rowID);
                    var newData = {
                    	name : name,
                    	category : category,
                    	desc : desc,
                    	price : price,
                    	status : status,
                    	available : available,
                    	id : rowData.id
                    };
                	$('#jqxgrid').jqxGrid('updaterow', rowID, newData);
                    $("#popupWindow").jqxWindow('hide');
            	}
            });
            
	    	$("#cancelbtn").click(function () {
            	$("#popupWindow").jqxWindow('hide');
            });
            
	    	$("#category").on('change', function(event){
	    		if(event.args == null){
	    			var newcategory = $("#category").val();
	    			if(newcategory != null && newcategory.trim() != ""
	    					&& $("#category").jqxComboBox('getItemByValue', newcategory) == null){
    					$("#category").jqxComboBox('addItem', newcategory);
    					$("#category").val(newcategory);
	    			}
	    		}
	    	});
	    	
	    	$("#groupbtn").jqxButton({theme: theme, width: '80', height: '25'});
	    	$("#addbtn").jqxButton({ theme: theme, width: '50', height: '25' });
            $("#delbtn").jqxButton({ theme: theme, width: '50', height: '25' });
            $("#updatemenubtn").jqxButton({ theme: theme, width: '80', height: '25' });
            
            $("#groupbtn").bind('click', function () {
            	if($("#groupbtn")[0].value == "按分类显示"){
	    			groupByCategory(true);
	    			$("#groupbtn")[0].value = "显示全部";
	    		} else {
	    			groupByCategory(false);
	    			$("#groupbtn")[0].value = "按分类显示";
	    		}
            });
            
            $("#addbtn").bind('click', function () {
            	editrow = -1;
            	$("#name").val("");
            	$("#desc").val("");
            	$("#category").jqxComboBox('selectIndex', 0);
            	$("#price").jqxNumberInput({ decimal: 0 });
                $("#status").jqxCheckBox({ checked : true });
                $("#popupWindow").jqxWindow('open');
            });
            
            $("#updatemenubtn").bind('click', function () {
           		AppUtil.request("updateClientsFood.action", null, function(result){
           			if(result && result.isSuccess == true){
           				alert("客户端将在收到通知后开始更新菜单!");
           			}
           		});
            });
            
	   	}
	   	
    	$(document).ready(function () {
    		AppUtil.request("searchFood.action", null, function(result){
    			if(result && result.length > 0){
    		    	for(var i=0; i < result.length; i++){
    		    		var rowdata = {};
    		    		var item = result[i];
    		    		rowdata.id = item.id;
    		    		rowdata.name =  item.name
    		    		rowdata.category = item.category;
    		    		addCategory(item.category);
    		    		rowdata.desc = item.description;
    		    		rowdata.price = item.price;
    		    		rowdata.status = AppUtil.getFoodStatus(item.status);
    		    		if(item.status == 1){
    		    			rowdata.available = true;
    		    		} else {
    		    			rowdata.available = false;
    		    		}
    		    		data.push(rowdata);
    		    	}
    		    	setupView();
    			}
    		}, function(){
    			alert("Fail to get data!");
    		});

	    });
	    
    </script>
</head>
	
<body class='default'>
	<div id="content">
   		<table style="width:100%">
    		<tr style="width:100%">
				<td style="width:100%" align="center">
			    	<div id="controlbar" style="width:800px">
			    		<div style="float:left">
		                	<input id="addbtn" type="button" value="新增" />
		            	</div>
   						<div style="float:left; padding-left:10px">
		                	<input id="delbtn" type="button" value="删除" />
		            	</div>
		            	<div style="float:left; padding-left:10px">
		                	<input id="groupbtn" type="button" value="按分类显示" />
		            	</div>
		            	<div style="float:right">
		                	<input id="updatemenubtn" type="button" value="一键更新" />
		            	</div>
			    	</div>
	    		</td>
    		</tr>
   			<tr style="width:100%">
   				<td style="width:100%" align="center">
				   	<div id='jqxWidget' style="font-size: 13px; font-family: Verdana;">
        				<div id="jqxgrid"></div>
    				</div>
   				</td>
   			</tr>
   		</table>
   		<div id="popupWindow">
            <div>编辑</div>
            <div style="overflow: hidden;">
                <table style="width:100%">
                    <tr style="width:100%; height:25px">
                        <td align="right" width="30%">菜名:</td>
                        <td align="left"><input id="name" style="width: 120px"/></td>
                    </tr>
                    <tr style="width:100%; height:25px">
                        <td align="right" width="30%">分类:</td>
                        <td align="left"><div id="category"></div></td>
                    </tr>
                    <tr style="width:100%; height:25px">
                        <td align="right" width="30%">描述:</td>
                        <td align="left"><input id="desc" style="width: 120px"/></td>
                    </tr>
                    <tr style="width:100%; height:25px">
                        <td align="right" width="30%">价格:</td>
                        <td align="left"><div id="price"></div></td>
                    </tr>
                    <tr style="width:100%; height:25px">
                        <td align="right" width="30%">状态:</td>
                        <td align="left"><div id="status"></div></td>
                    </tr>
                    <tr style="width:100%; height:25px">
                        <td style="padding-top: 10px;" align="center" colspan="2">
	                       <input style="margin-right: 5px;" type="button" id="savebtn" value="保存" />
	                       <input id="cancelbtn" type="button" value="取消" />
                        </td>
                    </tr>
                </table>
            </div>
       </div>
	</div>
</body>
</html>